<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>

	<title>图片上传压缩</title>
	
</head>
<body>

	<p><input type="file" name="" id="upload" accept="image/jpeg" /></p>
	<ul id="result">
	</ul>


<script src="http://js.3conline.com/min2/temp/v2/lib-zepto.js" charset="utf-8"></script>		
<script>
(function(){

	function convertImgToBase64(file,callback){
		var reader = new FileReader
		reader.onload = function(e){

			var base64 = reader.result;

			var mime = getMIME(base64);

			callback.call(this,base64,mime);
		}
		reader.readAsDataURL(file)
	}


	function getDataURL(img,mime,quality){
	  
	     var cvs = document.createElement('canvas');

	     cvs.width = img.width;
	     cvs.height = img.height;

	    cvs.getContext("2d").drawImage(img, 0, 0);


	     return cvs.toDataURL(mime, quality/100);
	}



	function createImg(data,callback){
		var img = new Image();
		img.src = data;
		
		img.onload = function(){
			callback.call(img,img);
		}
	}

	function getMIME(base64){
		var reg = /data\:(image\/[a-z]*);base64/i;

		var match = base64.match(reg);

		if(match) return match[1];

	}

	/*
	@param{DOM} file:上传控件
	@param{Number} quality:压缩质量参数，值：0~100
	@param{Function} callback:回调函数，返回两个参数：beforeBase64-压缩前base64，afterBase64-压缩后base64
	*/
	function imgZIP(file,quality,callback){

		var beforeBase64,
			afterBase64;

		var file = file.files[0];

		convertImgToBase64(file,function(base64,mime){

			beforeBase64 = base64;

			createImg(beforeBase64,function(img){

				afterBase64 = getDataURL(img,mime,quality);

				callback.call(file,beforeBase64,afterBase64);

			});


		});
	}


	window.imgZIP = imgZIP;


})(window);













var zip = [80,50,30,10];

document.getElementById("upload").onchange = function(){

	$("#result").html("");

	var file = this;

	var first;

	zip.forEach(function(value,index){

		imgZIP(file,value,function(beforeBase64,afterBase64){
			if(!first){
				show(100,beforeBase64);
				first = true;
			}
			show(value,afterBase64);
		});

	})

	
}



function show(id,data){
	
	$("#result").append('<li id="'+id+'"><img src="'+data+'" alt="" /></li>');

	$.ajax({
		url:"http://192.168.50.26/demo/2015/datauri/getImageSize.php",
		type:"post",
		data:{
			base64:data,
			id:id
		},
		success:function(data){
			var data = JSON.parse(data);
			if(data.id==100){
				$("#"+data.id).prepend('<p>未压缩前：'+parseFloat(data.size).toFixed(2)+'KB</p>')
			}else{
				$("#"+data.id).prepend('<p>压缩质量'+data.id+'%，压缩后'+parseFloat(data.size).toFixed(2)+'KB</p>')
			}
		}
	});

}

 


</script>

</body>
</html>